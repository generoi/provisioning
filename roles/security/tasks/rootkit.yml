---
# Part: Security
#
# Description: Enables rootkit detection and manually checks
#
# @TODO set notify email
#
# Parameters:
# - rkhunter.enabled (default: true)
# - rkhunter.update_propeties (default: false)
# - rkhunter.notify_email (default: false)
#
# Dependencies:
#
# Creates:
# - /etc/cron.weekly/rkhunter-cron
#
# File modifications:
#
###############################################################################
- name: Security | Install rootkit prevention software: rkunter
  apt:
    pkg=rkhunter
    state=present
  tags:
    - rootkit
    - rkhunter
    - install

- name: rkhunter | Check for updates
  command: rkhunter --check
  tags:
    - rootkit
    - rkhunter
    - update

- name: rkhunter | Check for updates
  command: rkhunter --check
  tags:
    - rootkit
    - rkhunter
    - update

- name: rkhunter | Update system file properties
  command: rkhunter --propupd
  when: rootkit.update_properties
  tags:
    - rootkit
    - rkhunter
    - update

# Only enabled if both enabled and notify_email specified
- name: rkhunter | Run rootkit check at 2am on every sunday: /etc/cron.weekly/rkhunter-cron
  template:
    src=rkhunter-cron.j2
    dest=/etc/cron.weekly/rkhunter-cron
  when: rootkit.enabled and rootkit.notify_email
  tags:
    - rootkit
    - rkhunter
    - cron
    - enable

- name: rkhunter | Disable cron: /etc/cron.weekly/rkhunter-cron
  file:
    path=/etc/cron.weekly/rkhunter-cron
    state=absent
  when: not rootkit.enabled or not rootkit.notify_email
  tags:
    - rooktkit
    - rkhunter
    - cron
    - disable
